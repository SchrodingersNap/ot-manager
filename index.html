<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOCL OT Manager (Jan 2026)</title>
    <style>
        :root { --primary: #0d47a1; --accent: #1976d2; --bg: #f4f6f8; --text: #333; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1000px; margin: 0 auto; }
        
        h1 { color: var(--primary); margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        /* Containers */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 5px solid var(--accent); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* Inputs */
        label { font-weight: bold; font-size: 0.85em; display: block; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        textarea { height: 100px; font-family: monospace; font-size: 0.85em; }
        
        /* Buttons */
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { background: #002171; }
        button.secondary { background: #757575; }
        button.danger { background: #d32f2f; }
        button.action-btn { width: auto; padding: 5px 10px; font-size: 0.8em; margin-right: 5px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #e3f2fd; text-align: left; padding: 10px; font-size: 0.9em; text-transform: uppercase; color: #0d47a1; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr.dc-row { background-color: #fff3e0; }
        
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold; }
        .badge-dc { background: #ff9800; color: white; }
        .badge-grp { background: #e0e0e0; color: #333; }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>✈️ IOCL OT Manager (Jan 2026)</h1>
        <div class="subtitle">Zero-Base Start with Excel Calculation Logic</div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('daily')">Daily Operation</div>
        <div class="tab" onclick="switchTab('init')">Initialize (Excel Calc)</div>
        <div class="tab" onclick="switchTab('roster')">View Roster</div>
    </div>

    <div id="daily">
        <div class="card">
            <h3>1. Shift Setup</h3>
            <div class="grid">
                <div>
                    <label>Groups on Duty (e.g., 1 7)</label>
                    <input type="text" id="dutyGroups" placeholder="Enter numbers separated by space">
                </div>
                <div>
                    <label>Current Shift (Hrs to Add)</label>
                    <select id="shiftType">
                        <option value="A">Shift A (+6 Hrs)</option>
                        <option value="B">Shift B (+8 Hrs)</option>
                        <option value="C">Shift C (+10 Hrs)</option>
                    </select>
                </div>
            </div>

            <br>
            <div class="grid">
                <div>
                    <label>Absentees (Comma separated)</label>
                    <input type="text" id="absentees" placeholder="Name 1, Name 2...">
                </div>
                <div>
                    <label>Duty Swap: [Who is Working] for [Who is Off]</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="dc_replacer" placeholder="Worker (Replacer)">
                        <span style="padding-top:10px">for</span>
                        <input type="text" id="dc_original" placeholder="Original (Off)">
                    </div>
                    <small style="color: #666;">* Worker goes to bottom of list. Original is marked absent.</small>
                </div>
            </div>

            <br>
            <button onclick="generateList()">Generate Priority List</button>
        </div>

        <div id="resultArea" class="card hidden">
            <h3>2. OT Priority Sequence</h3>
            <table id="otTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Grp</th>
                        <th>Current Hrs</th>
                        <th>Update</th>
                    </tr>
                </thead>
                <tbody id="otTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="init" class="hidden">
        <div class="card">
            <h3>Initial Calculation (Reset Mode)</h3>
            <p>Paste the Excel data (e.g. from 31st Dec) to calculate the starting hours for the sequence.</p>
            <label>Paste Excel Data (Column A to E):</label>
            <textarea id="excelPaste" placeholder="513748  Tej Singh Meena   OPTR   31-12-2025   B&#10;503538  Rajendra Kumar    JR.C   31-12-2025   C"></textarea>
            
            <br><br>
            <button class="secondary" onclick="calculateFromExcel()">Calculate & Add Hours</button>
            <br><br>
            <button class="danger" onclick="resetAllZero()">⚠️ Reset Everyone to ZERO</button>
        </div>
    </div>

    <div id="roster" class="hidden">
        <div class="card">
            <h3>Current Database Status</h3>
            <input type="text" id="searchRoster" onkeyup="renderRoster()" placeholder="Search...">
            <table id="rosterTable">
                <thead>
                    <tr>
                        <th>Name (Official)</th>
                        <th>Internal ID</th>
                        <th>Group</th>
                        <th>Total Hours</th>
                    </tr>
                </thead>
                <tbody id="rosterBody"></tbody>
            </table>
        </div>
    </div>

<script>
    // === CONFIGURATION ===
    const SHIFT_HOURS = { 'A': 6, 'B': 8, 'C': 10 };

    // === MASTER ROSTER ===
    const defaultRoster = [
        // GROUP 1
        { name: "Bidhan", official: "Bidhan Deb Barma", group: 1, hours: 0 },
        { name: "S. Paul", official: "S. Paul", group: 1, hours: 0 },
        { name: "G. Biswas", official: "Gourab Biswas", group: 1, hours: 0 },
        { name: "Pradeep", official: "Pradip Kumar Mondal", group: 1, hours: 0 }, 
        { name: "M. Saha", official: "M. Saha", group: 1, hours: 0 },
        { name: "P.K. Mondal", official: "Pradip Kumar Mondal", group: 1, hours: 0 }, // UPDATED HERE
        { name: "P.K. Meena", official: "P.K. Meena", group: 1, hours: 0 },

        // GROUP 2
        { name: "Pankaj", official: "Pankaj Choudhary", group: 2, hours: 0 },
        { name: "P. Roy", official: "Partha Roy", group: 2, hours: 0 },
        { name: "M. Swami", official: "Mukesh Swami", group: 2, hours: 0 },
        { name: "Joydeb", official: "Joydeb Mandal", group: 2, hours: 0 },
        { name: "A.C. Tirkey", official: "A.C. Tirkey", group: 2, hours: 0 },
        { name: "Kingshuk", official: "Kingshuk Barman", group: 2, hours: 0 },
        { name: "S. Dutta", official: "S. Dutta", group: 2, hours: 0 },
        { name: "R.K. Paul", official: "Rajib Kumar Paul", group: 2, hours: 0 },

        // GROUP 3
        { name: "R. Kumar", official: "Rajendra Kumar", group: 3, hours: 0 },
        { name: "Amit", official: "Amit Kumar", group: 3, hours: 0 },
        { name: "V. Ambedkar", official: "Varasala Ambedkar", group: 3, hours: 0 },
        { name: "Vikas", official: "Vikas Chhikara", group: 3, hours: 0 },
        { name: "D. Dey", official: "D. Dey", group: 3, hours: 0 },
        { name: "S.K. Mondal", official: "S.K. Mondal", group: 3, hours: 0 },
        { name: "S. Maji", official: "Sukumar Maji", group: 3, hours: 0 },
        { name: "A.K. Roy", official: "A.K. Roy", group: 3, hours: 0 },
        { name: "P. Karmakar", official: "P. Karmakar", group: 3, hours: 0 },

        // GROUP 4
        { name: "Mohit", official: "Mohit", group: 4, hours: 0 },
        { name: "Jitender", official: "Jitender .", group: 4, hours: 0 },
        { name: "S.J. Banerjee", official: "Subhra Jyoti Banerjee", group: 4, hours: 0 },
        { name: "T.S. Meena", official: "Tej Singh Meena", group: 4, hours: 0 },
        { name: "S. Hembram", official: "S. Hembram", group: 4, hours: 0 },
        { name: "Rajib Sen", official: "Rajib Sen", group: 4, hours: 0 },
        { name: "Gopal", official: "Gopal", group: 4, hours: 0 },
        { name: "Kalyan", official: "Kalyan Mondal", group: 4, hours: 0 },

        // GROUP 5
        { name: "C.N. Mitra", official: "C.N. Mitra", group: 5, hours: 0 },
        { name: "Sudhir", official: "Sudhir", group: 5, hours: 0 },
        { name: "Manjeet", official: "Manjeet .", group: 5, hours: 0 },
        { name: "Somnath Mondal", official: "Somnath Mondal", group: 5, hours: 0 },
        { name: "Biswarup", official: "Biswarup", group: 5, hours: 0 },
        { name: "Ashok Dasgupta", official: "Ashok Dasgupta", group: 5, hours: 0 },
        { name: "Sanjay Dey", official: "Sanjay Dey", group: 5, hours: 0 },
        { name: "Sanjit", official: "Sanjit Mondal", group: 5, hours: 0 },

        // GROUP 6
        { name: "S. Saha", official: "S. Saha", group: 6, hours: 0 },
        { name: "Soumen", official: "Soumen Mondal", group: 6, hours: 0 },
        { name: "Naveen", official: "Naveen", group: 6, hours: 0 },
        { name: "S. Ghosh", official: "Shayaml Ghosh", group: 6, hours: 0 },
        { name: "Dhirendra", official: "Dhirendra", group: 6, hours: 0 },
        { name: "Soumalaya", official: "Soumalaya", group: 6, hours: 0 },

        // GROUP 7
        { name: "A. Ali", official: "A. Ali", group: 7, hours: 0 },
        { name: "Nitin", official: "Nitin", group: 7, hours: 0 },
        { name: "Anil", official: "Anil", group: 7, hours: 0 },
        { name: "G. Patra", official: "G. Patra", group: 7, hours: 0 },
        { name: "P.K. Saha", official: "P.K. Saha", group: 7, hours: 0 },
        { name: "Sabir Ahmed", official: "Sabir Ahmed", group: 7, hours: 0 },
        { name: "Somnath Das", official: "Somnath Das", group: 7, hours: 0 },
        { name: "Hemlal Sharma", official: "Hemlal Sharma", group: 7, hours: 0 }
    ];

    let roster = [];

    // === STARTUP ===
    window.onload = function() {
        const saved = localStorage.getItem('iocl_jan_2026_v2');
        if (saved) {
            roster = JSON.parse(saved);
        } else {
            roster = JSON.parse(JSON.stringify(defaultRoster));
        }
        renderRoster();
    };

    function saveData() {
        localStorage.setItem('iocl_jan_2026_v2', JSON.stringify(roster));
        renderRoster();
    }

    // === DAILY LOGIC ===
    function generateList() {
        const dutyGroups = document.getElementById('dutyGroups').value.split(/[\s,]+/).map(Number).filter(n=>n>0);
        const shiftType = document.getElementById('shiftType').value;
        const absenteesInput = document.getElementById('absentees').value.toLowerCase().split(',');
        
        const replacerName = document.getElementById('dc_replacer').value.trim();
        const originalName = document.getElementById('dc_original').value.trim();

        let finalSequence = [];
        let absentIndices = [];

        // Identify Absentees
        absenteesInput.forEach(txt => {
            if(txt.trim()) {
                let match = findPerson(txt.trim());
                if(match) absentIndices.push(match.index);
            }
        });

        // Duty Swap: Original is Absent
        let replacerObj = null;
        if(originalName) {
            let orig = findPerson(originalName);
            if(orig) absentIndices.push(orig.index);
        }
        
        // Duty Swap: Replacer
        if(replacerName) {
            let rep = findPerson(replacerName);
            if(rep) {
                // Check if replacer is listed as absent (e.g. mutual swap), remove from absent list
                if(absentIndices.includes(rep.index)) {
                    absentIndices = absentIndices.filter(i => i !== rep.index);
                }
                replacerObj = { ...roster[rep.index], isDC: true, originalIndex: rep.index };
            }
        }

        roster.forEach((p, idx) => {
            if (absentIndices.includes(idx)) return;
            if (replacerObj && replacerObj.name === p.name) return; // Add replacer later

            if (dutyGroups.includes(p.group)) {
                finalSequence.push({ ...p, isDC: false, originalIndex: idx });
            }
        });

        finalSequence.sort((a, b) => a.hours - b.hours);

        if (replacerObj) {
            finalSequence.push(replacerObj);
        }

        renderTable(finalSequence, shiftType);
    }

    function renderTable(list, shiftType) {
        const tbody = document.getElementById('otTableBody');
        tbody.innerHTML = '';
        document.getElementById('resultArea').classList.remove('hidden');

        const hoursToAdd = SHIFT_HOURS[shiftType];

        list.forEach((p, rank) => {
            const tr = document.createElement('tr');
            if(p.isDC) tr.className = 'dc-row';

            tr.innerHTML = `
                <td><strong>D${rank+1}</strong></td>
                <td>
                    ${p.official}
                    ${p.isDC ? '<br><span class="badge badge-dc">Duty Swap</span>' : ''}
                </td>
                <td><span class="badge badge-grp">${p.group}</span></td>
                <td>${p.hours}</td>
                <td>
                    <button class="action-btn" onclick="updateHours(${p.originalIndex}, ${hoursToAdd}, false)">Work (+${hoursToAdd})</button>
                    <button class="action-btn danger" onclick="updateHours(${p.originalIndex}, ${hoursToAdd}, true)">Refuse (+${hoursToAdd})</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateHours(idx, amount, isRefusal) {
        const p = roster[idx];
        if(confirm(`Update ${p.name}?\n${p.hours} -> ${p.hours + amount}`)) {
            p.hours += amount;
            saveData();
            generateList(); 
        }
    }

    // === EXCEL CALCULATOR ===
    function calculateFromExcel() {
        const text = document.getElementById('excelPaste').value;
        const lines = text.split('\n');
        let count = 0;

        lines.forEach(line => {
            const parts = line.split(/\t/); 
            if(parts.length >= 2) {
                const excelName = parts[1].trim();
                const shiftChar = parts.length >= 5 ? parts[4].trim().toUpperCase() : '';
                
                if (SHIFT_HOURS[shiftChar]) {
                    const hrs = SHIFT_HOURS[shiftChar];
                    const match = findPerson(excelName);
                    
                    if (match) {
                        roster[match.index].hours += hrs;
                        count++;
                    }
                }
            }
        });
        
        saveData();
        alert(`Processed ${count} entries. Initial hours updated.`);
    }

    // === UTILITIES ===
    function findPerson(query) {
        query = query.toLowerCase();
        // 1. Exact Official
        let idx = roster.findIndex(p => p.official.toLowerCase() === query);
        if(idx !== -1) return { index: idx, ...roster[idx] };
        
        // 2. Contains Official
        idx = roster.findIndex(p => p.official.toLowerCase().includes(query) || query.includes(p.official.toLowerCase()));
        if(idx !== -1) return { index: idx, ...roster[idx] };

        // 3. Internal Name
        idx = roster.findIndex(p => p.name.toLowerCase().includes(query));
        if(idx !== -1) return { index: idx, ...roster[idx] };
        
        return null;
    }

    function resetAllZero() {
        if(confirm("Are you sure? This will set ALL hours to 0.")) {
            roster.forEach(p => p.hours = 0);
            saveData();
        }
    }

    function switchTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#daily, #init, #roster').forEach(d => d.classList.add('hidden'));
        event.target.classList.add('active');
        document.getElementById(id).classList.remove('hidden');
    }

    function renderRoster() {
        const tbody = document.getElementById('rosterBody');
        tbody.innerHTML = '';
        const search = document.getElementById('searchRoster').value.toLowerCase();
        
        roster.forEach(p => {
            if(search && !p.official.toLowerCase().includes(search) && !p.name.toLowerCase().includes(search)) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.official}</td><td>${p.name}</td><td>${p.group}</td><td>${p.hours}</td>`;
            tbody.appendChild(tr);
        });
    }

</script>
</body>
</html>
